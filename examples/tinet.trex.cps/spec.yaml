#                       BR
#                       |
#   (net0) -- HV1 ------+
# T1                    |
#   (net1) -- HV2 ------+
#                       |
#             L1  ------+
#                       |
#             N1  ------+
nodes:
- name: T1
  image: ghcr.io/slankdev/mfplane-trex:branch-main
  #image: nicolaka/netshoot
  docker_run_extra_args: --entrypoint bash
  interfaces:
  - { name: net0, type: direct, args: HV1#net1 }
  - { name: net1, type: direct, args: HV2#net1 }
  sysctls:
  - sysctl: net.ipv6.conf.all.disable_ipv6=0
  - sysctl: net.ipv6.conf.default.disable_ipv6=0
- name: HV1
  image: tinynetwork/vpp:develop
  docker_run_extra_args: --entrypoint bash
  interfaces:
  - { name: net0, type: direct, args: BR#hv1 }
  - { name: net1, type: direct, args: T1#net0 }
  sysctls:
  - sysctl: net.ipv6.conf.all.disable_ipv6=0
  - sysctl: net.ipv6.conf.default.disable_ipv6=0
- name: HV2
  image: tinynetwork/vpp:develop
  docker_run_extra_args: --entrypoint bash
  interfaces:
  - { name: net0, type: direct, args: BR#hv2 }
  - { name: net1, type: direct, args: T1#net1 }
  sysctls:
  - sysctl: net.ipv6.conf.all.disable_ipv6=0
  - sysctl: net.ipv6.conf.default.disable_ipv6=0
- name: BR
  image: nicolaka/netshoot
  docker_run_extra_args: --entrypoint bash
  interfaces:
  - { name: hv1, type: direct, args: HV1#net0 }
  - { name: hv2, type: direct, args: HV2#net0 }
  - { name: l1 , type: direct, args: L1#net0 }
  - { name: n1 , type: direct, args: N1#net0 }
  - { name: n2 , type: direct, args: N2#net0 }
  sysctls: []
- name: L1
  image: ghcr.io/slankdev/mfplane-mfpctl:branch-main
  docker_run_extra_args: --entrypoint bash
  interfaces:
  - { name: net0, type: direct, args: BR#l1 }
  sysctls:
  - sysctl: net.ipv4.ip_forward=1
  - sysctl: net.ipv6.conf.all.disable_ipv6=0
  - sysctl: net.ipv6.conf.default.disable_ipv6=0
- name: N1
  image: ghcr.io/slankdev/mfplane-mfpctl:branch-main
  docker_run_extra_args: --entrypoint bash
  interfaces:
  - { name: net0, type: direct, args: BR#n1 }
  sysctls:
  - sysctl: net.ipv4.ip_forward=1
  - sysctl: net.ipv6.conf.all.disable_ipv6=0
  - sysctl: net.ipv6.conf.default.disable_ipv6=0
- name: N2
  image: ghcr.io/slankdev/mfplane-mfpctl:branch-main
  docker_run_extra_args: --entrypoint bash
  interfaces:
  - { name: net0, type: direct, args: BR#n2 }
  sysctls:
  - sysctl: net.ipv4.ip_forward=1
  - sysctl: net.ipv6.conf.all.disable_ipv6=0
  - sysctl: net.ipv6.conf.default.disable_ipv6=0

node_configs:
- name: T1
  cmds:
  - cmd: ip link set net0 down
  - cmd: ip link set net0 address 52:54:00:01:00:01
  - cmd: ip link set net0 up
  - cmd: ip link set net1 down
  - cmd: ip link set net1 address 52:54:00:02:00:01
  - cmd: ip link set net1 up
  - cmd: nohup ./_t-rex-64 -i --astf --cfg ./cfg.yaml >/dev/null &

  # - cmd: ip netns add ns0
  # - cmd: ip link set net0 netns ns0
  # - cmd: ip netns exec ns0 ip link set lo up
  # - cmd: ip netns exec ns0 ip link set net0 up
  # - cmd: ip netns exec ns0 ip addr add 20.0.0.1/32 dev lo
  # - cmd: ip netns exec ns0 ip addr add 50.0.0.2/24 dev net0
  # - cmd: ip netns exec ns0 ip route add default via 50.0.0.1
  # - cmd: ip netns exec ns0 ethtool -K net0 rx off tso off gso off tx off
  # - cmd: ip netns add ns1
  # - cmd: ip link set net1 netns ns1
  # - cmd: ip netns exec ns1 ip link set lo up
  # - cmd: ip netns exec ns1 ip link set net1 up
  # - cmd: ip netns exec ns1 ip addr add 30.0.0.1/32 dev lo
  # - cmd: ip netns exec ns1 ip addr add 40.0.0.2/24 dev net1
  # - cmd: ip netns exec ns1 ip route add default via 40.0.0.1
  # - cmd: ip netns exec ns1 ethtool -K net1 rx off tso off gso off tx off

- name: BR
  cmds:
  - cmd: ip link add br0 type bridge
  - cmd: ip link set br0 up
  - cmd: ip link set hv1 master br0
  - cmd: ip link set hv2 master br0
  - cmd: ip link set l1 master br0
  - cmd: ip link set n1 master br0
  - cmd: ip link set n2 master br0
- name: HV1
  cmds:
  - cmd: ip link set net0 down
  - cmd: ip link set net0 address 52:54:00:ff:00:01
  - cmd: ip link set net0 up
  - cmd: nohup vpp -c /etc/vpp/startup.conf &
- name: HV2
  cmds:
  - cmd: ip link set net0 down
  - cmd: ip link set net0 address 52:54:00:ff:00:02
  - cmd: ip link set net0 up
  - cmd: nohup vpp -c /etc/vpp/startup.conf &
- name: L1
  cmds:
  - cmd: ip link set net0 down
  - cmd: ip link set net0 address 52:54:00:ff:00:03
  - cmd: ip link set net0 up
- name: N1
  cmds:
  - cmd: ip link set net0 down
  - cmd: ip link set net0 address 52:54:00:ff:00:04
  - cmd: ip link set net0 up
- name: N2
  cmds:
  - cmd: ip link set net0 down
  - cmd: ip link set net0 address 52:54:00:ff:00:05
  - cmd: ip link set net0 up

postinit:
  cmds:
  - cmd: |
      cat <<EOF > /tmp/t1_cfg.yaml
      - port_limit: 2
        version: 2
        interfaces:
        - net0
        - net1
        port_info:
        - {ip: 50.0.0.2, default_gw: 50.0.0.1}
        - {ip: 40.0.0.2, default_gw: 40.0.0.1}
      EOF
  - cmd: |
      cat <<EOF > /tmp/hv1_exec.vpp
      create host-interface name net0
      create host-interface name net1
      set int state host-net0 up
      set int state host-net1 up
      ip table add 10
      set int ip table host-net1 10
      set interface mac address host-net0 52:54:00:ff:00:01
      set interface mac address host-net1 52:54:00:01:00:02

      set int ip addr host-net0 2001::1/64
      set int ip addr host-net1 50.0.0.1/24
      ip route add table 10 20.0.0.0/8 via 50.0.0.2 host-net1
      ip route add fc00:ff00::/24 via fe80::5054:ff:feff:3 host-net0
      set ip neighbor host-net1 50.0.0.2 52:54:00:01:00:01
      set int feature host-net0 ip4-not-enabled arc ip4-unicast disable

      set sr encaps source addr fc00:1100::
      sr policy add bsid cafe::10 next fc00:ff01:: fib-table 0
      sr steer l3 30.0.0.0/8 via bsid cafe::10 fib-table 10
      sr localsid address fc00:1100:: behavior end
      sr localsid address fc00:1101:: behavior end.dt4 10
      EOF
  - cmd: |
      cat <<EOF > /tmp/hv2_exec.vpp
      create host-interface name net0
      create host-interface name net1
      set int state host-net0 up
      set int state host-net1 up
      set interface mac address host-net0 52:54:00:ff:00:02
      set interface mac address host-net1 52:54:00:02:00:02

      set int ip addr host-net0 2001::2/64
      set int ip addr host-net1 40.0.0.1/24
      ip route add 142.0.0.0/8 via fe80::5054:ff:feff:3 host-net0
      ip route add 30.0.0.0/8 via 40.0.0.2 host-net1
      ip route add fc00:1100::/24 via fe80::5054:ff:feff:1 host-net0
      set ip neighbor host-net1 40.0.0.2 52:54:00:02:00:01
      set int feature host-net0 ip4-not-enabled arc ip4-unicast disable
      EOF
  - cmd: docker exec HV1 mkdir -p /etc/vpp
  - cmd: docker exec HV2 mkdir -p /etc/vpp
  - cmd: docker cp /tmp/t1_cfg.yaml  T1:/opt/trex/cfg.yaml
  - cmd: docker cp /tmp/hv1_exec.vpp HV1:/etc/vpp/exec.vpp
  - cmd: docker cp /tmp/hv2_exec.vpp HV2:/etc/vpp/exec.vpp
  - cmd: mkdir -p /var/run/netns
  - cmd: ln -s /proc/$(docker inspect L1 -f {{.State.Pid}})/ns/net /var/run/netns/L1
  - cmd: ln -s /proc/$(docker inspect N1 -f {{.State.Pid}})/ns/net /var/run/netns/N1
  - cmd: ln -s /proc/$(docker inspect N2 -f {{.State.Pid}})/ns/net /var/run/netns/N2
