- hosts: dplaneNode
  become: true
  become_method: sudo
  gather_facts: no
  tags: [benchmark,load]
  tasks:
  - name: stop iperf client contaner
    register: tmp
    tags: client
    changed_when: "'CHANGED' in tmp.stdout"
    shell: |
      set -xe
      {% for c in containers %}
      {% if c.host == inventory_hostname %}
      {% if c.benchmark is defined and c.benchmark.role == "client" %}
      CN={{ c.name }}-iperf
      docker stop $CN || true
      echo CHANGED
      {% endif %}
      {% endif %}
      {% endfor %}

  - name: wait iperf container is finished
    changed_when: false
    tags: client
    shell: |
      set -xe
      {% for c in containers %}
      {% if c.host == inventory_hostname %}
      {% if c.benchmark is defined and c.benchmark.role == "client" %}
      #!/bin/bash
      while :
      do
        echo check
        if [ $(docker inspect {{ c.name }}-iperf \
          | jq .[0].State.Running) = "false" ]; then
          break
        fi
        sleep 1
      done
      echo done
      {% endif %}
      {% endif %}
      {% endfor %}

  - name: stop iperf server contaner
    register: tmp
    tags: server
    changed_when: "'CHANGED' in tmp.stdout"
    shell: |
      set -xe
      {% for c in containers %}
      {% if c.host == inventory_hostname %}
      {% if c.benchmark is defined and c.benchmark.role == "server" %}
      CN={{ c.name }}-iperf
      docker stop $CN || true
      echo CHANGED
      {% endif %}
      {% endif %}
      {% endfor %}
